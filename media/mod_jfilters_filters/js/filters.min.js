/**
 * @copyright   Copyright Â© 2024 Blue-Coder.com. All rights reserved.
 * @license     GNU General Public License 2 or later, see COPYING.txt for license details.
 */
"use strict";window.JFilters=window.JFilters||{},JFilters.updater={async updateComponent(e,t=0){const i=decodeURI(Joomla.getOptions("system.paths").baseFull);let s=new URL(e,i);s.searchParams.set("tmpl","component");const l="#jf_results";document.querySelector(l).classList.add("jf_results--loading"),t&&null!==Joomla.optionsStorage["jfilters.filter"]&&"object"==typeof Joomla.optionsStorage["jfilters.filter"]&&(Joomla.optionsStorage["jfilters.filter"]=[]),await this.update(s,l,".joomla-script-options").then((()=>{document.querySelector(l).classList.remove("jf_results--loading");let i=Joomla.getOptions("jfilters.results");return i.title&&this.setTitle(i.title),this.setUrl(e,i.title),t&&(void 0!==JFilters.filteringModule&&void 0!==JFilters.filteringModule.boot&&JFilters.filteringModule.boot(),void 0!==JFilters.selectionsModule&&void 0!==JFilters.selectionsModule.boot&&JFilters.selectionsModule.boot(),void 0!==JFilters.calendar&&JFilters.calendar.boot(),void 0!==JFilters.tooltip&&JFilters.tooltip.boot(),void 0!==JFilters.range_inputs&&JFilters.range_inputs.boot(),void 0!==JFilters.range_sliders&&JFilters.range_sliders.boot()),document.dispatchEvent(new CustomEvent("JfResultsUpdate",{bubbles:!0,cancelable:!0,detail:{url:e}})),!0}))},async updateModule(e,t,i){const s=decodeURI(Joomla.getOptions("system.paths").baseFull);let l=new URL(e,s);return l.searchParams.set("view","module"),l.searchParams.set("module_id",t),l.searchParams.set("tmpl","component"),this.update(l,i,".joomla-script-options","mod_jfilters_filters_"+t)},async update(e,t,i="script",s=""){const l=await this.fetchResource(e);l&&await this.injectResponse(l,t).then((()=>{l.applyJs(i)})).catch((e=>{console.log('Error updating scripts": '+e.message)})).then((()=>{l.applyCss(s)})).catch((e=>{console.log('Error updating styles": '+e.message)})).then((()=>(this.loadOptions(),Promise.resolve())))},fetchResource:e=>fetch(e).then((e=>{if(e.ok)return e.text();throw new Error(`JFilters error! status: ${e.status} - ${e.statusText}`)})).catch((t=>{console.error(`JFilters error updating "${e}": `+t.message)})),injectResponse(e,t){let i=document.querySelector(t),s=document.createElement("jf-temp-results-wrapper");s.innerHTML=e;let l=s.querySelector(t);return i.innerHTML=l?l.innerHTML:"",s.remove(),Promise.resolve()},loadOptions(){const e=document.querySelector(".joomla-script-options");e.className=e.className.replace(" loaded"," new"),Joomla.loadOptions()},setTitle(e){document.title=e},setUrl(e,t){window.history.pushState({pageTitle:t},t,e)}},window.JFilters.filteringModule={moduleWrapperSelectorPrefix:"#mod-jfilters_filters-",moduleSubmitButtonSelector:".mod-jfilters_filters__submit-btn",filterHeaderSelector:".jfilters-filter-header__toggle",filterInnerContainerSelector:".jfilters-filter-container__inner",filterSearchContainerSelector:".jfilters-filter-search"},window.JFilters.filteringModule.instances=window.JFilters.filteringModule.instances||{},JFilters.sessionStorageEnabled=JFilters.sessionStorageEnabled||function(){const e="testKey";try{return sessionStorage.setItem(e,e),sessionStorage.removeItem(e),!0}catch(e){return!1}},JFilters.filteringModule.module=class{constructor(e,t=0,i=0,s=0){this.id=e,this.useAjax=parseInt(t),this.submitWithButton=parseInt(s),this.isPro=!1,this.isYOOthemeTemplate=parseInt(i),this.filters=[],this.moduleWrapper=document.querySelector(window.JFilters.filteringModule.moduleWrapperSelectorPrefix+this.id),JFilters.filteringModule.instances[this.id]=this,this.init()}init(){const e=this.moduleWrapper?this.moduleWrapper.querySelector(window.JFilters.filteringModule.moduleSubmitButtonSelector):null;this.submitWithButton&&e&&e.addEventListener("click",(()=>{const t=e.dataset.url;if(t)if(this.useAjax)document.dispatchEvent(new CustomEvent("JfResultsUpdateStart",{bubbles:!0,cancelable:!0,detail:{moduleId:this.id,url:t}})),JFilters.updater.updateComponent(t,this.isYOOthemeTemplate);else{const e=decodeURI(Joomla.getOptions("system.paths").baseFull);let i=new URL(t,e);window.location=i}}))}registerFilter(e){this.filters[e.id]=e}update(e){null!==Joomla.optionsStorage["jfilters.filter"]&&"object"==typeof Joomla.optionsStorage["jfilters.filter"]&&(Joomla.optionsStorage["jfilters.filter"]=[]);const t=window.JFilters.filteringModule.moduleWrapperSelectorPrefix+this.id;if(!this.isYOOthemeTemplate||this.submitWithButton){const i=this.submitWithButton?this.moduleWrapper.querySelector(window.JFilters.filteringModule.moduleSubmitButtonSelector):null;if(i){i.setAttribute("disabled","true");const e=i.querySelector(".jfilters_button__label");e&&e.classList.add("jfilters_button__label--hide");const t=i.querySelector(".jfilters__loadMore_dots");t&&t.classList.remove("jfilters__loadMore_dots--hide")}JFilters.updater.updateModule(e,this.id,t).then((()=>{if(i){i.removeAttribute("disabled");const e=i.querySelector(".jfilters_button__label");e&&e.classList.remove("jfilters_button__label--hide");const t=i.querySelector(".jfilters__loadMore_dots");t&&t.classList.add("jfilters__loadMore_dots--hide")}JFilters.filteringModule.boot("",this.id),void 0!==JFilters.calendar&&JFilters.calendar.boot(),void 0!==JFilters.tooltip&&JFilters.tooltip.boot(),void 0!==JFilters.range_inputs&&JFilters.range_inputs.boot(),void 0!==JFilters.range_sliders&&JFilters.range_sliders.boot(),document.dispatchEvent(new CustomEvent("JfFilteringModuleUpdate",{bubbles:!0,cancelable:!0,detail:{moduleId:this.id,url:e}}))}))}else JFilters.filteringModule.boot("",this.id)}},JFilters.filteringModule.Filter=class{constructor(e,t,i){if(this.filterWrapper=document.getElementById("jfilters-filter-container-"+i+"-"+e),null===this.filterWrapper)return!1;this.id=e,this.moduleId=i,this.filterKey="jfilters/filter/"+this.moduleId+"/"+this.id;let s=JSON.parse(t);for(let e in s)this[e]=s[e];if(!JFilters.filteringModule.instances[i])return!1;JFilters.filteringModule.instances[i].isPro=this.isPro,JFilters.filteringModule.instances[i].registerFilter(this),this.init()}init(){if(this.loadExpandedByLocalStorage(),this.filterWrapper.querySelector(window.JFilters.filteringModule.filterHeaderSelector).addEventListener("click",(()=>this.toggleFilter())),this.setAjaxUpdateEvents(),this.filterWrapper.querySelector(".dropdown")&&this.handleBootstrapDropDown(),this.isTree){let e=[].slice.call(this.filterWrapper.querySelectorAll(".jfilters-item__toggle-btn"));if(!this.parent_node_linkable){let t=[].slice.call(this.filterWrapper.querySelectorAll(".jfilters-item-link[aria-expanded]"));e=e.concat(t)}e.forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),this.toggleTree(e)}))}))}}setAjaxUpdateEvents(){if(this.isPro&&JFilters.filteringModule.instances[this.moduleId].useAjax||JFilters.filteringModule.instances[this.moduleId].submitWithButton){const e=this.filterWrapper.querySelector(window.JFilters.filteringModule.filterInnerContainerSelector);if(e){[].slice.call(e.querySelectorAll("a:not([aria-controls])")).forEach((e=>{e.addEventListener("click",(t=>{const i=e.closest("a").getAttribute("href");t.preventDefault(),t.stopPropagation(),this.update(i,!JFilters.filteringModule.instances[this.moduleId].submitWithButton)}))}))}}}update(e,t=!0){return!(!this.isPro||!JFilters.filteringModule.instances[this.moduleId].useAjax&&!JFilters.filteringModule.instances[this.moduleId].submitWithButton)&&(JFilters.filteringModule.instances[this.moduleId].update(e),t&&(document.dispatchEvent(new CustomEvent("JfResultsUpdateStart",{bubbles:!0,cancelable:!0,detail:{moduleId:this.moduleId,url:e}})),JFilters.updater.updateComponent(e,JFilters.filteringModule.instances[this.moduleId].isYOOthemeTemplate)),document.dispatchEvent(new CustomEvent("JfFilteringLinkClick",{bubbles:!0,cancelable:!0,detail:{moduleId:this.moduleId,url:e}})),!0)}loadExpandedByLocalStorage(){let e=this.getStorageVariable("hidden");const t=this.filterWrapper.querySelector(window.JFilters.filteringModule.filterInnerContainerSelector);e&&t&&t.getAttribute("aria-hidden")!=e&&this.toggleFilter()}toggleFilter(){const e=this.filterWrapper.querySelector(window.JFilters.filteringModule.filterInnerContainerSelector);if(e){let t="true"==e.getAttribute("aria-hidden")?"false":"true";e.setAttribute("aria-hidden",t);const i=this.filterWrapper.querySelector(window.JFilters.filteringModule.filterHeaderSelector);i&&i.setAttribute("aria-expanded","true"==t?"false":"true"),this.setStorageVariable("hidden",t)}}toggleTree(e,t=!0){let i=e.closest("li").querySelector("ul");if(i){let s="true"==e.getAttribute("aria-expanded")?"false":"true";if(e.setAttribute("aria-expanded",s),t){let t="BUTTON"==e.nodeName?e.closest("li").querySelector("a[aria-controls]"):e.closest("li").querySelector("button[aria-controls]");t&&this.toggleTree(t,!1);let l="true"==s?"false":"true";i.setAttribute("aria-hidden",l)}return!0}return!1}handleBootstrapDropDown(){let e=this.filterWrapper.querySelector(".dropdown"),t=this.filterWrapper.querySelector(window.JFilters.filteringModule.filterSearchContainerSelector);if(e&&t){let i=t.querySelector('input[type="text"]'),s=this.filterWrapper.querySelector(".jfilters-filter-dropdown-toggle__label"),l=this.filterWrapper.querySelector(".jfilters-filter-dropdown__clear"),r="jfilters-filter-search--hide",o="jfilters-filter-dropdown-toggle__label--hide",n="jfilters-filter-dropdown__clear--hide";e.addEventListener("show.bs.dropdown",(function(){s.classList.add(o),t.classList.remove(r),l&&l.classList.add(n)})),e.addEventListener("hidden.bs.dropdown",(function(){s.classList.contains("jfilters-filter-dropdown-toggle__label--noSelection")||(s.classList.remove(o),t.classList.add(r),l&&l.classList.remove(n)),i.value="";const e=new InputEvent("input",{bubbles:!0,cancelable:!0});i.dispatchEvent(e)})),e.addEventListener("shown.bs.dropdown",(function(){i.focus()}))}}getStorageVariable(e){if(JFilters.sessionStorageEnabled()){let t=this.filterKey+"/"+e;return sessionStorage.getItem(t)}return!1}setStorageVariable(e,t){if(JFilters.sessionStorageEnabled()){let i=this.filterKey+"/"+e;return sessionStorage.setItem(i,t),!0}return!1}createUrl(e,t,i,s="path"){e=Array.isArray(e)?e:[e];let l=t;if("path"==s&&-1===l.indexOf("?"))l+="/"+i+"/"+e.join("|");else{let t=0;e.forEach((e=>{let s=0===t&&-1===l.indexOf("?")?"?":"&";l+=s+i+`[${t}]=`+e,t++}))}return l}},JFilters.listSearch=class{constructor(e,t={}){this.options={cache:!0,caseSensitive:!1,ignoreKeys:[13,27,32,37,38,39,40],matchAnywhere:!0,optionClass:".jfilters-item__label-text",trigger:"input"},this.setOptions(t),this.filterWrapper=document.getElementById("jfilters-filter-container__inner-"+e.moduleId+"-"+e.id),this.observeElement=this.filterWrapper.querySelector(".jfilters-filter-search__input"),this.elements=[].slice.call(this.filterWrapper.querySelectorAll(".jfilters-filter-list__item")),0===this.elements.length&&(this.elements=[].slice.call(this.filterWrapper.querySelectorAll(".jfilters-filter-dropdown__item"))),this.matches=this.elements,this.observeElement&&this.listen()}setOptions(e){for(const[t,i]of Object.entries(e))this.options[t]=i}listen(){this.observeElement.addEventListener(this.options.trigger,function(e){if(this.observeElement.value.length)this.options.ignoreKeys.includes(e.code)||(this.start(),this.findMatches(this.options.cache?this.matches:this.elements));else{this.elements.forEach((e=>{e.classList.remove("jfilters-filter-list__item--hidden")})),this.findMatches(this.elements,!0),this.clearHtmlFromText(this.elements),this.filterWrapper.querySelector(".jfilters-filter-search__clear").classList.add("jfilters-filter-search__clear--hidden"),this.hideHiddenLists()}}.bind(this))}start(){this.elements.forEach((e=>{e.classList.add("jfilters-filter-list__item--hidden")}));let e=this.filterWrapper.querySelector(".jfilters-filter-search__clear");e.classList.remove("jfilters-filter-search__clear--hidden"),e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.observeElement.value="",this.findMatches(this.elements,!0),this.clearHtmlFromText(this.elements),e.classList.add("jfilters-filter-search__clear--hidden"),this.hideHiddenLists()}))}showHiddenLists(){[].slice.call(this.filterWrapper.querySelectorAll('.jfilters-filter-list [aria-hidden="true"]')).forEach((e=>{e.classList.add("jfilters-filter-list--visible")}))}hideHiddenLists(){[].slice.call(this.filterWrapper.querySelectorAll(".jfilters-filter-list--visible")).forEach((e=>{e.classList.remove("jfilters-filter-list--visible")}))}show(e){e.classList.remove("jfilters-filter-list__item--hidden");let t=e.closest(".jfilters-filter-list__item--hidden");t&&this.show(t)}hide(e){e.classList.add("jfilters-filter-list__item--hidden")}matchText(e){let t=this.observeElement.value;const i=e.querySelector(this.options.optionClass),s=i.textContent,l=s.toLowerCase(),r=t.toLowerCase();let o=l.indexOf(r);if(-1===o){o=l.normalize("NFD").replace(/[\u0300-\u036f]/g,"").indexOf(r)}const n=s.substring(o,o+t.length);i.innerHTML=s.replace(n,'<span class="jfilters-item__text--search-match">'+n+"</span>")}findMatches(e,t){let i=this.observeElement.value;const s={"+":"\\+","*":"\\*",".":"\\.","(":"\\(",")":"\\)","|":"\\|","?":"\\?","^":"\\^",$:"\\$"};i=i.replace(/[\+\*\.\(\)\|\?,\^,\$]/g,(e=>s[e]));const l=this.options.matchAnywhere?i:"^"+i,r=this.options.caseSensitive?"":"i",o=new RegExp(l,r);this.showHiddenLists(),e.forEach((e=>{let i=e.querySelector(this.options.optionClass).textContent;const s=e.classList.contains("jfilters-item-link--clear");let l=void 0===t?o.test(i):t;return s||l||(i=i.normalize("NFD").replace(/[\u0300-\u036f]/g,""),l=o.test(i)),!l||!1!==s&&!0!==t?this.hide(e):(this.matchText(e),this.show(e)),!0}))}clearHtmlFromText(e){e.forEach((e=>{const t=e.querySelector(this.options.optionClass),i=t.textContent;t.innerHTML=i,this.hideHiddenLists()}))}},JFilters.filteringModule.boot=(e,t="")=>{if(!window.JFilters||!window.JFilters.filteringModule||"object"!=typeof window.JFilters.filteringModule)throw new Error("The JFilters API is not correctly registered.");const i=Joomla.getOptions("jfilters.filteringModule");void 0!==i&&i.forEach((e=>{t&&e.id!=t||new JFilters.filteringModule.module(e.id,e.ajax_mode,e.isYOOthemeTemplate,e.submit_filters_using_button)}));const s=Joomla.getOptions("jfilters.filter");void 0!==s&&s.forEach((e=>{if(t&&e.moduleId!=t)return;let i=new JFilters.filteringModule.Filter(e.id,e.properties,e.moduleId);new JFilters.listSearch(i)}))},String.prototype.applyJs=function(e){const t=document.createElement("jf-temp-js-wrapper");t.innerHTML=this;let i=[].slice.call(t.querySelectorAll(e));if(t.remove(),i&&1==i.length){const t=document.querySelector(e);if(t){if("application/json"==t.getAttribute("type"))try{const e=Joomla.optionsStorage,s=JSON.parse(i[0].text||i[0].textContent);let l="jfilters.filter";null!==s[l]&&"object"==typeof s[l]&&null!==e[l]&&"object"==typeof e[l]&&(s[l].forEach(((t,i)=>{let s=!1;e[l].every(((e,i)=>{e.id!==t.id||e.moduleId!==t.moduleId||(s=!0)})),s||e[l].push(t)})),s[l]=null),l="jfilters.results",null!==s[l]&&"object"==typeof s[l]&&null!==e[l]&&"object"==typeof e[l]&&(e[l]=s[l]);const r={...s,...e};Joomla.optionsStorage={},t.text=JSON.stringify(r)}catch(e){throw console.error(e),e}else t.innerHTML+=scriptPlain}}return this},String.prototype.applyCss=function(e){if(!e)return!1;const t=document.createElement("jf-temp-js-wrapper");t.innerHTML=this;const i=t.querySelector("#"+e);if(t.remove(),i){const t=i.innerHTML,s=document.querySelector("#"+e);if(!s&&t){let i=document.createElement("style");i.id=e,i.appendChild(document.createTextNode(t)),(document.head||document.getElementsByTagName("head")[0]).appendChild(i)}else s.innerHTML=t}return!0},document.addEventListener("DOMContentLoaded",JFilters.filteringModule.boot),document.addEventListener("JfSelectionsLinkClick",(function(e){if(e.detail&&e.detail.url){const t=Joomla.getOptions("jfilters.filteringModule");void 0!==t&&t.forEach((t=>{t.isYOOthemeTemplate||JFilters.filteringModule.instances[t.id].update(e.detail.url)}))}})),document.addEventListener("JfResultsUpdateStart",(function(e){if(e.detail&&e.detail.url&&e.detail.moduleId){const t=Joomla.getOptions("jfilters.filteringModule");void 0!==t&&t.forEach((t=>{t.id==e.detail.moduleId||t.isYOOthemeTemplate||JFilters.filteringModule.instances[t.id].update(e.detail.url)}))}})),window.addEventListener("popstate",(()=>{location.hash||location.reload()}));
